"use strict";(self.webpackChunkadar=self.webpackChunkadar||[]).push([[9122],{39122:function(e,t,s){s.r(t),s.d(t,{default:function(){return R}});var i=s(60760),r=s(70655),a=s(25387),o=s.n(a),n=s(52151),c=s.n(n),h=s(3767),l=s(53545),p=s(36930),m=s(50576),d=s(74180),u=s(62380),f=s(80710),g=s(16546),b=s(72160),y=s(85530),F=s(14904),P=s(25108);const{SnapshotTypes:k}=m.OY;var C;!function(e){e.LINE="line",e.CANDLE="candlestick"}(C||(C={}));const v={[C.LINE]:u.a.LineIcon,[C.CANDLE]:u.a.CandleIcon},A=[{name:F.D.DAY,label:"1D",type:k.DEFAULT,count:288},{name:F.D.WEEK,label:"1W",type:k.HOUR,count:168},{name:F.D.MONTH,label:"1M",type:k.DAY,count:30},{name:F.D.YEAR,label:"1Y",type:k.DAY,count:365},{name:F.D.ALL,label:"ALL",type:k.DAY,count:1/0}],D=[{name:F.D.FIVE_MINUTES,label:"5m",type:k.DEFAULT,count:48},{name:F.D.FIFTEEN_MINUTES,label:"15m",type:k.DEFAULT,count:144,group:3},{name:F.D.THIRTY_MINUTES,label:"30m",type:k.DEFAULT,count:288,group:6},{name:F.D.HOUR,label:"1h",type:k.HOUR,count:24},{name:F.D.FOUR_HOURS,label:"4h",type:k.HOUR,count:96,group:4},{name:F.D.DAY,label:"1D",type:k.DAY,count:90}],S="Sora",U=10,T=e=>(t,s,i)=>p.FPNumber.gt(e,p.FPNumber.ZERO)?t:p.FPNumber.lt(e,p.FPNumber.ZERO)?s:i,x=(e,t)=>`${new p.FPNumber(e).toLocaleString()} ${t}`,E=(e,t)=>0!==t?e/t:0,N=(e,t)=>e.map(((e,s)=>E(e,t[s]))),L=e=>{let t=2;if(0===e||!Number.isFinite(e))return t;let s=Math.abs(e);for(;Math.floor(s)<=0;)s*=10,t++;return t};let w=class extends((0,l.Wr)(d.Z,m.tA.LoadingMixin,m.tA.NumberFormatterMixin,m.tA.FormattedAmountMixin)){constructor(...e){super(...e),(0,i.Z)(this,"tokenFrom",void 0),(0,i.Z)(this,"tokenTo",void 0),(0,i.Z)(this,"isAvailable",void 0),(0,i.Z)(this,"isFetchingError",!1),(0,i.Z)(this,"FontWeightRate",m.it.FontWeightRate),(0,i.Z)(this,"samplesBuffer",{}),(0,i.Z)(this,"pageInfos",{}),(0,i.Z)(this,"prices",[]),(0,i.Z)(this,"zoomStart",0),(0,i.Z)(this,"zoomEnd",100),(0,i.Z)(this,"precision",2),(0,i.Z)(this,"limits",{min:1/0,max:0}),(0,i.Z)(this,"updatePrices",(0,y._1)(this.getHistoricalPrices,250,{leading:!1})),(0,i.Z)(this,"forceUpdatePrices",(0,y._1)(this.resetAndUpdatePrices,250,{leading:!1})),(0,i.Z)(this,"priceUpdateRequestId",0),(0,i.Z)(this,"priceUpdateWatcher",null),(0,i.Z)(this,"priceUpdateTimestampSync",null),(0,i.Z)(this,"chartType",C.LINE),(0,i.Z)(this,"selectedFilter",A[0]),(0,i.Z)(this,"isReversedChart",!1)}handleTokensChange(e,t){if(!o()(e)(t)){const s=this.isReversedChart?[...t].reverse():t;this.isReversedChart=!1,o()(e)(s)||this.forceUpdatePrices()}}get isLineChart(){return this.chartType===C.LINE}get inputTokensAddresses(){return[this.tokenFrom,this.tokenTo].filter((e=>!!e)).map((e=>e.address))}get tokenA(){return this.isReversedChart?this.tokenTo:this.tokenFrom}get tokenB(){return this.isReversedChart?this.tokenFrom:this.tokenTo}get tokens(){return[this.tokenA,this.tokenB].filter((e=>!!e))}get tokensAddresses(){return this.tokens.map((e=>e.address))}get tokensPair(){return 2===this.tokensAddresses.length}get chartTypeButtons(){return Object.values(C).map((e=>({type:e,icon:v[e],active:this.chartType===e})))}get filters(){return this.isLineChart?A:D}get symbol(){return this.tokenB?.symbol??"USD"}get fromFiatPrice(){return this.tokenA?p.FPNumber.fromCodecValue(this.getAssetFiatPrice(this.tokenA)??0):p.FPNumber.ZERO}get toFiatPrice(){return this.tokenB?p.FPNumber.fromCodecValue(this.getAssetFiatPrice(this.tokenB)??0):p.FPNumber.ZERO}get fiatPrice(){return this.toFiatPrice.isZero()?this.fromFiatPrice:this.fromFiatPrice.div(this.toFiatPrice)}get fiatPriceFormatted(){return this.fiatPrice.toLocaleString()}get isAllHistoricalPricesFetched(){return Object.entries(this.pageInfos).some((([e,t])=>!t.hasNextPage&&!this.samplesBuffer[e]?.length))}get timeDifference(){return 1e3*b.wY[this.selectedFilter.type]}get visibleChartItemsRange(){const e=this.chartData.length;return[Math.floor(e*this.zoomStart/100),Math.ceil(e*this.zoomEnd/100)-1]}get priceChange(){const[e,t]=this.visibleChartItemsRange,s=new p.FPNumber(this.chartData[e]?.[2]??0),i=new p.FPNumber(this.chartData[t]?.[2]??0);return(0,y._Q)(i,s)}get gridLeftOffset(){const e=10*this.limits.max;return 16+(0,y.mY)(String(e.toFixed(this.precision)),S,U)}get chartData(){const e=[],{prices:t,selectedFilter:{group:s}}=this,i=t.slice().reverse();for(let t=0;t<i.length;t++)if(s&&t%s!=0){const s=c()(e);s&&(s[2]=i[t].price[1],s[3]=Math.min(s[3],i[t].price[2]),s[4]=Math.max(s[4],i[t].price[3]))}else e.push([i[t].timestamp,...i[t].price]);return Object.freeze(e)}get chartSpec(){return{dataset:{source:this.chartData,dimensions:["timestamp","open","close","low","high"]},grid:this.gridSpec({left:this.gridLeftOffset}),xAxis:this.xAxisSpec({boundaryGap:!this.isLineChart&&[.005,.005]}),yAxis:this.yAxisSpec({axisLabel:{formatter:e=>e.toFixed(this.precision)},axisPointer:{label:{precision:this.precision}}}),dataZoom:[{type:"inside",start:0,end:100,minValueSpan:11*this.timeDifference}],color:[this.theme.color.theme.accent,this.theme.color.status.success],tooltip:this.tooltipSpec({axisPointer:{type:"cross"},formatter:e=>{const{data:t,seriesType:s}=e[0],[i,r,a,o,n]=t;if(s===C.LINE)return x(a,this.symbol);if(s===C.CANDLE){const e=(0,y._Q)(new p.FPNumber(a),new p.FPNumber(r)),t=T(e)(this.theme.color.status.success,this.theme.color.status.error,this.theme.color.base.content.primary);return`\n              <table>\n                ${[{title:"Open",data:x(r,this.symbol)},{title:"High",data:x(n,this.symbol)},{title:"Low",data:x(o,this.symbol)},{title:"Close",data:x(a,this.symbol)},{title:"Change",data:(c=e,`${T(c)("+","","")}${(0,y.Gc)(c,!0)}`),color:t}].map((e=>`\n                  <tr>\n                    <td align="right" style="color:${this.theme.color.base.content.secondary}">${e.title}</td>\n                    <td style="color:${e.color??this.theme.color.base.content.primary}">${e.data}</td>\n                  </tr>\n                `)).join("")}\n              </table>\n            `}var c}}),series:[this.isLineChart?this.lineSeriesSpec({encode:{y:"close"},areaStyle:{opacity:.8,color:new h.Q.o(0,0,0,1,[{offset:0,color:"rgba(248, 8, 123, 0.25)"},{offset:1,color:"rgba(255, 49, 148, 0.03)"}])}}):this.candlestickSeriesSpec()]}}created(){this.forceUpdatePrices()}beforeDestroy(){this.unsubscribeFromPriceUpdates()}async fetchData(e){const{type:t,count:s}=this.selectedFilter,i=this.pageInfos[e],r=this.samplesBuffer[e]??[],a=[];let o=i?.hasNextPage??!0,n=i?.endCursor??"";if(r.length>=s)return{nodes:a,hasNextPage:o,endCursor:n};let c=s;do{const s=Math.min(c,100),i=await m.m5.price.getHistoricalPriceForAsset(e,t,s,n);if(!i)throw new Error("Chart data fetch error");o=i.pageInfo.hasNextPage,n=i.pageInfo.endCursor,a.push(...i.nodes),c-=i.nodes.length}while(o&&c>0);return{nodes:a,hasNextPage:o,endCursor:n}}getUpdatedPrecision(e,t){return Math.max(L(e),L(t))}async getHistoricalPrices(){if(this.loading||this.isAllHistoricalPricesFetched)return;if(this.tokensPair&&!this.isAvailable)return;const e=[...this.tokensAddresses],t=Date.now(),s=c()(this.prices)?.timestamp??Date.now();this.priceUpdateRequestId=t,await this.withApi((async()=>{try{const i=await Promise.all(e.map((e=>this.fetchData(e))));if(!(i&&o()(e)(this.tokensAddresses)&&o()(t)(this.priceUpdateRequestId)))return;const r={},a=[],n=[],h=s??1e3*Math.max(i[0]?.nodes[0]?.timestamp??0,i[1]?.nodes[0]?.timestamp??0);i.forEach((({hasNextPage:t,endCursor:s,nodes:i},a)=>{const o=e[a],l=i.map((e=>(e=>{const t=1e3*+e.timestamp,s=(e=>{const{open:t,close:s,low:i,high:r}=e.priceUSD;return[+t,+s,+i,+r]})(e);return{timestamp:t,price:s}})(e))),p=((e,t,s)=>{const i=[];for(const r of e){const e=[],a=c()(i)?.timestamp??s;let o=r.timestamp;for(;(o+=t)<a;)e.push({timestamp:o,price:[r.price[1],r.price[1],r.price[1],r.price[1]]});i.push(...e.reverse(),r)}return i})((this.samplesBuffer[o]??[]).concat(l),this.timeDifference,h);n.push(p),r[o]={hasNextPage:t,endCursor:s}}));const l=Math.min(n[0]?.length??1/0,n[1]?.length??1/0,this.selectedFilter.count);let{min:p,max:m}=this.limits;for(let e=0;e<l;e++){const t=n[0]?.[e],s=n[1]?.[e],i=t?.timestamp??s?.timestamp,r=s?.price&&t?.price?N(t.price,s.price):t?.price??[0,0,0,0];if(0===r[0]&&0===r[1])break;a.push({timestamp:i,price:r}),p=Math.min(p,...r),m=Math.max(m,...r)}e.forEach(((e,t)=>{this.samplesBuffer[e]=Object.freeze(n[t].slice(l))})),this.limits={min:p,max:m},this.pageInfos=r,this.precision=this.getUpdatedPrecision(p,m),this.updatePricesCollection([...this.prices,...a]),this.isFetchingError=!1}catch(e){this.isFetchingError=!0,P.error(e)}}))}unsubscribeFromPriceUpdates(){this.priceUpdateWatcher&&this.priceUpdateWatcher(),this.priceUpdateTimestampSync&&clearInterval(this.priceUpdateTimestampSync),this.priceUpdateWatcher=null,this.priceUpdateTimestampSync=null}subscribeToPriceUpdates(){this.unsubscribeFromPriceUpdates();const e=[...this.tokensAddresses];this.priceUpdateWatcher=this.$watch((()=>this.fiatPriceObject),((t,s)=>{!t||s&&!e.some((e=>t[e]!==s[e]))||this.handlePriceUpdates(e,t)})),this.priceUpdateTimestampSync=setInterval((()=>this.handlePriceTimestampSync(e)),6e3)}getCurrentSnapshotTimestamp(){const e=Math.floor(Date.now()/1e3),t=this.timeDifference/1e3;return t*Math.floor(e/t)*1e3}handlePriceTimestampSync(e){if(!o()(e)(this.tokensAddresses))return;const t=this.getCurrentSnapshotTimestamp(),s=this.prices[0];if(!s||t===s.timestamp)return;const i=s.price[1],r={timestamp:t,price:[i,i,i,i]};this.updatePricesCollection([r,...this.prices])}handlePriceUpdates(e,t){if(!o()(e)(this.tokensAddresses))return;const s=this.getCurrentSnapshotTimestamp(),i=this.prices[0],[r,a]=this.tokensAddresses.map((e=>p.FPNumber.fromCodecValue(t[e]??0).toNumber())),n=Number.isFinite(a)?E(r,a):r,c=Math.min(this.limits.min,n),h=Math.max(this.limits.max,n),l=i?.price?.[0]??n,m=i?.price?.[2]??n,d=i?.price?.[3]??n,u=i?.timestamp===s,f={timestamp:s,price:[u?l:n,n,Math.min(m,n),Math.max(d,n)]},g=[...this.prices];u&&g.shift(),g.unshift(f),this.precision=this.getUpdatedPrecision(c,h),this.limits={min:c,max:h},this.updatePricesCollection(g)}clearData(e=!1){this.samplesBuffer={},this.pageInfos={},this.prices=[],this.zoomStart=0,this.zoomEnd=100,this.limits={min:1/0,max:0},this.precision=2,e||(this.isReversedChart=!1)}updatePricesCollection(e){this.prices=Object.freeze(e)}changeFilter(e){this.selectedFilter=e,this.forceUpdatePrices(!0)}async resetAndUpdatePrices(e=!1){this.clearData(e),await this.updatePrices(),this.subscribeToPriceUpdates()}selectChartType(e){this.chartType=e,this.changeFilter(this.filters[0])}handleZoom(e){e?.stop?.(),e?.wheelDelta<0&&0===this.zoomStart&&100===this.zoomEnd&&this.updatePrices()}changeZoomLevel(e){const t=e?.batch?.[0];this.zoomStart=t?.start??0,this.zoomEnd=t?.end??0}revertChart(){this.isReversedChart=!this.isReversedChart,this.forceUpdatePrices(!0)}};(0,r.__decorate)([(0,l.fI)({default:()=>null,type:Object})],w.prototype,"tokenFrom",void 0),(0,r.__decorate)([(0,l.fI)({default:()=>null,type:Object})],w.prototype,"tokenTo",void 0),(0,r.__decorate)([(0,l.fI)({default:!1,type:Boolean})],w.prototype,"isAvailable",void 0),(0,r.__decorate)([(0,l.RL)("inputTokensAddresses")],w.prototype,"handleTokensChange",null),w=(0,r.__decorate)([(0,l.wA)({components:{TokenLogo:m.wx.TokenLogo,FormattedAmount:m.wx.FormattedAmount,SvgIconButton:(0,f.kF)(g.z8.SvgIconButton),TokensRow:(0,f.kF)(g.z8.TokensRow),PriceChange:(0,f.kF)(g.z8.PriceChange),StatsCard:(0,f.kF)(g.z8.StatsCard),StatsFilter:(0,f.kF)(g.z8.StatsFilter),ChartSkeleton:(0,f.kF)(g.z8.ChartSkeleton)}})],w);var I=w,R=(0,s(1001).Z)(I,(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("stats-card",{directives:[{name:"loading",rawName:"v-loading",value:e.parentLoading,expression:"parentLoading"}],scopedSlots:e._u([{key:"title",fn:function(){return[s("tokens-row",{attrs:{border:"",assets:e.tokens,size:"medium"}}),e.tokenA?s("div",{staticClass:"token-title"},[s("span",[e._v(e._s(e.tokenA.symbol))]),e.tokenB?s("span",[e._v("/"+e._s(e.tokenB.symbol))]):e._e()]):e._e(),e.tokensPair?s("s-button",{class:{"s-pressed":e.isReversedChart},attrs:{type:"action",alternative:"",icon:"arrows-swap-90-24"},on:{click:e.revertChart}}):e._e()]},proxy:!0},{key:"filters",fn:function(){return[s("stats-filter",{attrs:{filters:e.filters,value:e.selectedFilter},on:{input:e.changeFilter}})]},proxy:!0},{key:"types",fn:function(){return e._l(e.chartTypeButtons,(function(t){var i=t.type,r=t.icon,a=t.active;return s("svg-icon-button",{key:i,attrs:{icon:r,active:a,disabled:e.parentLoading||e.loading,size:"small"},on:{click:function(t){return e.selectChartType(i)}}})}))},proxy:!0}])},[s("chart-skeleton",{attrs:{loading:e.parentLoading||e.loading,"is-empty":0===e.chartData.length,"is-error":e.isFetchingError},on:{retry:e.updatePrices}},[s("formatted-amount",{staticClass:"charts-price",attrs:{value:e.fiatPriceFormatted,"font-weight-rate":e.FontWeightRate.MEDIUM,"font-size-rate":e.FontWeightRate.MEDIUM,"asset-symbol":e.symbol,"symbol-as-decimal":""}}),e.isFetchingError?e._e():s("price-change",{attrs:{value:e.priceChange}}),s("v-chart",{ref:"chart",staticClass:"chart",attrs:{option:e.chartSpec,autoresize:""},on:{"zr:mousewheel":e.handleZoom,datazoom:e.changeZoomLevel}})],1)],1)}),[],!1,null,null,null).exports}}]);